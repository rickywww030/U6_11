<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Unity Web Player | RE_Web</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">

  <style>
    html,body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden; background:#000;
    }
    #unity-container {
      position:fixed;
      top:0; left:0;
      transform-origin:center center;
    }
    #unity-canvas {
      display:block;
      width:100%; height:100%;
      background:#231F20;
    }
    /* Loading 條樣式（不變） */
    #unity-loading-bar { /* ... */ }
    #unity-logo           { /* ... */ }
    #unity-progress-bar-empty { /* ... */ }
    #unity-progress-bar-full  { /* ... */ }
    /* footer, warning 等保留 */
  </style>
</head>
<body>
  <div id="unity-container">
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <canvas id="unity-canvas" tabindex="-1"></canvas>
    <div id="unity-warning"></div>
    <div id="unity-footer">
      <div id="unity-logo-title-footer"></div>
      <div id="unity-fullscreen-button"></div>
      <div id="unity-build-title">RE_Web</div>
    </div>
  </div>

  <script>
    const canvas    = document.getElementById('unity-canvas');
    const container = document.getElementById('unity-container');
    let unityInstance = null;
    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

    // 一：初始化 canvas 和 container 大小
    function initSizes() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      container.style.width  = window.innerWidth + 'px';
      container.style.height = window.innerHeight + 'px';
    }

    // 二：根據方向與設備決定是否旋轉，並重新計算尺寸
    function updateRotation() {
      if (!isMobile || window.innerWidth >= window.innerHeight) {
        // 非手機 或 橫屏 → 清除所有 transform、復原原始尺寸
        container.style.transform = 'none';
        initSizes();
      } else {
        // 手機豎屏 → 先將 container 寬高交換，再左轉 90°，最後置中
        const w = window.innerWidth, h = window.innerHeight;
        container.style.width  = h + 'px';
        container.style.height = w + 'px';
        container.style.transform =
          `translate(${(w - h)/2}px, ${(h - w)/2}px) ` +  // 平移到中心
          `rotate(-90deg)`;
      }
    }

    // 三：節流 resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      initSizes();
      resizeTimer = setTimeout(updateRotation, 100);
    });

    // 初始呼叫
    initSizes();
    updateRotation();

    // 四：載入 Unity
    const buildUrl = 'Build';
    const config = {
      dataUrl:            buildUrl+'/WebGame.data.unityweb',
      frameworkUrl:       buildUrl+'/WebGame.framework.js.unityweb',
      codeUrl:            buildUrl+'/WebGame.wasm.unityweb',
      streamingAssetsUrl: 'StreamingAssets',
      companyName:        'ArtRice',
      productName:        'RE_Web',
      productVersion:     '0.1',
      devicePixelRatio:   1,
      matchWebGLToCanvasSize:false,
      showBanner:(msg,type)=>{
        const w = document.getElementById('unity-warning');
        const d = document.createElement('div');
        d.textContent = msg;
        d.style=`background:${type==='error'?'#f88':'#ff8'};padding:8px;`;
        w.appendChild(d);
        if(type!=='error') setTimeout(()=>w.removeChild(d),3000);
      }
    };

    // 手機 viewport
    if (isMobile) {
      const m = document.createElement('meta');
      m.name='viewport';
      m.content='width=device-width,height=device-height,initial-scale=1.0,user-scalable=no';
      document.head.appendChild(m);
    }

    // 載入 loader 並更新進度
    const loader = document.createElement('script');
    loader.src = buildUrl+'/WebGame.loader.js';
    loader.onload = () => {
      createUnityInstance(canvas, config, progress=>{
        document.getElementById('unity-progress-bar-full').style.width = (progress*100)+'%';
      }).then(inst => {
        unityInstance = inst;
        document.getElementById('unity-loading-bar').style.display = 'none';
        document.getElementById('unity-fullscreen-button')
                .onclick = ()=>inst.SetFullscreen(1);
      }).catch(alert);
    };
    document.body.appendChild(loader);

    // iOS bounce prevent
    document.documentElement.style.overscrollBehavior = 'none';
    document.documentElement.style.touchAction       = 'none';
  </script>
</body>
</html>
